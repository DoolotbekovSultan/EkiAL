# Repositories

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–∞–ø–∫–∞ `repositories` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—â–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ñ–∏—á–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –≠—Ç–∏ –∫–ª–∞—Å—Å—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—â–∏–º –¥–∞–Ω–Ω—ã–º.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞
**repositories/** - üîÑ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- shared_repository.dart - üéØ –ë–∞–∑–æ–≤—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

## –û–ø–∏—Å–∞–Ω–∏–µ

### repository.dart
–ë–∞–∑–æ–≤—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è –æ–±—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –°–æ–¥–µ—Ä–∂–∏—Ç:
- –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –≤—Å–µ—Ö –æ–±—â–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- –ë–∞–∑–æ–≤—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–±—â–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å shared –¥–∞–Ω–Ω—ã–º–∏
- –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### BaseRepository
–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –æ–±—â–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π:
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

### SharedRepository
–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ–±—â–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤:
- `get` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- `getAll` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
- `save` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- `delete` - —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- `clear` - –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –æ–±—â–∏–º –¥–∞–Ω–Ω—ã–º
- **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** - –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ–∂–¥—É —Ñ–∏—á–∞–º–∏
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ—Å—Ç—å** - –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö shared —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ –≤–ª–∏—è—é—Ç –Ω–∞ –≤—Å–µ —Ñ–∏—á–∏

## Best Practices

1. –ù–∞—Å–ª–µ–¥—É–π—Ç–µ –≤—Å–µ –æ–±—â–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –æ—Ç BaseRepository
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ
5. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –æ–±—â–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
6. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –º–æ–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
7. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –æ–ø–µ—Ä–∞—Ü–∏–π —Å –æ–±—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```dart
// –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –æ–±—â–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
abstract class BaseRepository<T> {
  Future<T?> get(String id);
  Future<List<T>> getAll();
  Future<void> save(T item);
  Future<void> delete(String id);
  Future<void> clear();
}

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±—â–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
abstract class SharedRepository<T> implements BaseRepository<T> {
  Future<T?> getFromCache(String id);
  Future<void> refresh();
  Stream<T?> watch(String id);
}

// –û–±—â–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—Å–µ—Ö —Ñ–∏—á
class UserRepository implements SharedRepository<UserModel> {
  final UserRemoteDataSource _remoteDataSource;
  final UserLocalDataSource _localDataSource;
  final Map<String, UserModel> _cache = {};

  UserRepository({
    required UserRemoteDataSource remoteDataSource,
    required UserLocalDataSource localDataSource,
  })  : _remoteDataSource = remoteDataSource,
        _localDataSource = localDataSource;

  @override
  Future<UserModel?> get(String id) async {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    if (_cache.containsKey(id)) {
      return _cache[id];
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    final localUser = await _localDataSource.getUser(id);
    if (localUser != null) {
      _cache[id] = localUser;
      return localUser;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
    try {
      final remoteUser = await _remoteDataSource.getUser(id);
      if (remoteUser != null) {
        await _localDataSource.saveUser(remoteUser);
        _cache[id] = remoteUser;
        return remoteUser;
      }
    } catch (e) {
      throw RepositoryException('Failed to get user: $e');
    }

    return null;
  }

  @override
  Future<List<UserModel>> getAll() async {
    // –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    try {
      final users = await _remoteDataSource.getAllUsers();
      await _localDataSource.saveAllUsers(users);
      _cache.clear();
      users.forEach((user) => _cache[user.id] = user);
      return users;
    } catch (e) {
      throw RepositoryException('Failed to get all users: $e');
    }
  }

  @override
  Future<void> save(UserModel user) async {
    try {
      await _localDataSource.saveUser(user);
      await _remoteDataSource.saveUser(user);
      _cache[user.id] = user;
    } catch (e) {
      throw RepositoryException('Failed to save user: $e');
    }
  }

  @override
  Future<void> delete(String id) async {
    try {
      await _localDataSource.deleteUser(id);
      await _remoteDataSource.deleteUser(id);
      _cache.remove(id);
    } catch (e) {
      throw RepositoryException('Failed to delete user: $e');
    }
  }

  @override
  Future<void> clear() async {
    await _localDataSource.clear();
    _cache.clear();
  }

  @override
  Future<UserModel?> getFromCache(String id) async {
    return _cache[id];
  }

  @override
  Future<void> refresh() async {
    _cache.clear();
    await _localDataSource.clear();
  }

  @override
  Stream<UserModel?> watch(String id) {
    // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    return Stream.fromFuture(get(id)).asBroadcastStream();
  }
}

// –ö–∞—Å—Ç–æ–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
class RepositoryException implements Exception {
  final String message;
  
  const RepositoryException(this.message);
  
  @override
  String toString() => 'RepositoryException: $message';
}