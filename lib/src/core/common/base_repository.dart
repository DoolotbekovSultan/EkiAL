// ================================
// üìö BASE REPOSITORY
// ================================

import 'package:dartz/dartz.dart';
import '../exceptions/failure.dart';

/// –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
///
/// –°–û–î–ï–†–ñ–ê–ù–ò–ï –ö–õ–ê–°–°–ê:
///
/// üéØ –û–°–ù–û–í–ù–´–ï –ú–ï–¢–û–î–´:
/// - [getAll] - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
/// - [getById] - –ø–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ ID
/// - [create] - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
/// - [update] - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
/// - [delete] - —É–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
///
/// üîß –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´:
/// - [handleException] - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
/// - [validateId] - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
/// - [cacheData] - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
///
/// üìù –ü–ê–†–ê–ú–ï–¢–†–´ –¢–ò–ü–ê:
/// - [T] - —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏
/// - [ID] - —Ç–∏–ø –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é String)
///
/// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
/// ```dart
/// class UserRepository extends BaseRepository<User> {
///   @override
///   Future<Either<Failure, User>> getById(String id) async {
///     // —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
///   }
/// }
/// ```

abstract class BaseRepository<T, ID> {
  // ================================
  // üéØ CRUD –û–ü–ï–†–ê–¶–ò–ò
  // ================================

  /// –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [Either] —Å [Failure] –∏–ª–∏ —Å–ø–∏—Å–∫–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ [List<T>]
  ///
  /// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  /// ```dart
  /// final result = await repository.getAll();
  /// result.fold(
  ///   (failure) => print('–û—à–∏–±–∫–∞: $failure'),
  ///   (users) => print('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: $users'),
  /// );
  /// ```
  Future<Either<Failure, List<T>>> getAll();

  /// –ü–æ–ª—É—á–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [id] - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [Either] —Å [Failure] –∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–º [T]
  Future<Either<Failure, T>> getById(ID id);

  /// –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [entity] - —Å–æ–∑–¥–∞–≤–∞–µ–º–∞—è —Å—É—â–Ω–æ—Å—Ç—å
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [Either] —Å [Failure] –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º [T]
  Future<Either<Failure, T>> create(T entity);

  /// –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [id] - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞
  /// - [entity] - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [Either] —Å [Failure] –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º [T]
  Future<Either<Failure, T>> update(ID id, T entity);

  /// –£–¥–∞–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [id] - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [Either] —Å [Failure] –∏–ª–∏ [bool] —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
  Future<Either<Failure, bool>> delete(ID id);

  // ================================
  // üîß –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´
  // ================================

  /// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ö –≤ [Failure]
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [exception] - –ø–æ–π–º–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
  /// - [stackTrace] - —Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ [Failure]
  ///
  /// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  /// ```dart
  /// try {
  ///   // –æ–ø–µ—Ä–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –≤—ã–±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
  /// } catch (e, s) {
  ///   return Left(handleException(e, s));
  /// }
  /// ```
  Failure handleException(dynamic exception, StackTrace stackTrace) {
    // –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
    return Failure.unknown(message: exception.toString());
  }

  /// –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [id] - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [bool] - –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
  ///
  /// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  /// ```dart
  /// if (!validateId(userId)) {
  ///   return Left(Failure.validation(message: '–ù–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'));
  /// }
  /// ```
  bool validateId(ID id) {
    if (id is String) {
      return id.isNotEmpty;
    } else if (id is int) {
      return id > 0;
    }
    return id != null;
  }

  /// –ö—ç—à–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [key] - –∫–ª—é—á –¥–ª—è –∫—ç—à–∞
  /// - [data] - –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
  ///
  /// –í –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö –∫–ª–∞—Å—Å–∞—Ö –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ª–æ–≥–∏–∫—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
  Future<void> cacheData(String key, dynamic data) async {
    // –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É—è shared_preferences –∏–ª–∏ hive
  }

  /// –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [key] - –∫–ª—é—á –∫—ç—à–∞
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ null
  Future<dynamic> getCachedData(String key) async {
    // –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
    return null;
  }

  // ================================
  // ‚ö° –£–¢–ò–õ–ò–¢–ù–´–ï –ú–ï–¢–û–î–´
  // ================================

  /// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [id] - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [Either] —Å [Failure] –∏–ª–∏ [bool] —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
  Future<Either<Failure, bool>> exists(ID id) async {
    try {
      final result = await getById(id);
      return result.fold(
        (failure) => const Right(false),
        (_) => const Right(true),
      );
    } catch (e, s) {
      return Left(handleException(e, s));
    }
  }

  /// –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [Either] —Å [Failure] –∏–ª–∏ [int] –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
  Future<Either<Failure, int>> count() async {
    try {
      final result = await getAll();
      return result.fold(
        (failure) => Left(failure),
        (items) => Right(items.length),
      );
    } catch (e, s) {
      return Left(handleException(e, s));
    }
  }
}

/// –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏
extension RepositoryExtensions<T, ID> on BaseRepository<T, ID> {
  /// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [T] –∏–ª–∏ null –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
  Future<T?> getByIdOrNull(ID id) async {
    final result = await getById(id);
    return result.fold((_) => null, (entity) => entity);
  }

  /// –ü–∞–∫–µ—Ç–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ —Å–ø–∏—Å–∫—É ID
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [ids] - —Å–ø–∏—Å–æ–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [Either] —Å [Failure] –∏–ª–∏ —Å–ø–∏—Å–∫–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ [List<T>]
  Future<Either<Failure, List<T>>> getByIds(List<ID> ids) async {
    try {
      final results = <T>[];
      for (final id in ids) {
        final result = await getById(id);
        result.fold(
          (failure) => throw failure,
          (entity) => results.add(entity),
        );
      }
      return Right(results);
    } catch (e, s) {
      return Left(handleException(e, s));
    }
  }
}
